<!DOCTYPE html>
<html lang="en">
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description" content="Datastax Cassandra Ruby Driver Documentation">
    <meta name="author" content="">

    <title>Datastax Cassandra Ruby Driver - Introduction</title>

    <link href="css/style.css" rel="stylesheet">
    <link href="css/pygments.css" rel="stylesheet">

    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body data-spy="scroll" data-target=".toc" data-offset="0">
    <div class="navbar navbar-default navbar-static-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="./">Cassandra Ruby Driver</a>
        </div>
        <div class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="./">Introduction</a></li>
            <li><a href="features/">Features</a></li>
            <li><a href="api/">API docs</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="row">
        <div class="col-md-9 content">
          <nav class="crumbs">
            <ol class="breadcrumb">
              
              
              
              <li class="active">Introduction</li>
              
              
              
            </ol>
          </nav>
          <h1 id="datastax-ruby-driver-for-apache-cassandra">Datastax Ruby Driver for Apache Cassandra</h1>

<p>A Ruby client driver for Apache Cassandra. It has built-in support for:</p>

<ul>
<li>one-off, <a href="features/prepared_statements/">prepared</a> and <a href="features/batch_statements/">batch statements</a>
</li>
<li><a href="features/asynchronous_io/">asynchronous execution</a></li>
<li>automatic peer discovery and cluster metadata</li>
<li>
<a href="features/load_balancing/">diverse load-balancing</a>, <a href="features/retry_policies/">retry</a> and reconnection policies, <a href="features/load_balancing/implementing_a_policy/">with ability to write your own</a>
</li>
</ul>

<p>This driver works exclusively with the Cassandra Query Language v3 (CQL3) and Cassandra’s native protocol. Cassandra versions 1.2 and 2.0 are supported as well as Ruby 1.9.3, 2.0, JRuby 1.7 and Rubinius 2.1.</p>

<p>This driver is based on <a href="https://github.com/iconara/cql-rb">the cql-rb gem</a> by <a href="https://github.com/iconara">Theo Hultberg</a>.</p>

<h2 id="quick-start">Quick start</h2>
<pre class="highlight"><code class="ruby"><span class="nb">require</span> <span class="s1">'cassandra'</span>

<span class="n">cluster</span> <span class="o">=</span> <span class="no">Cassandra</span><span class="o">.</span><span class="n">connect</span> <span class="c1"># connects to localhost by default</span>

<span class="n">cluster</span><span class="o">.</span><span class="n">each_hosts</span> <span class="k">do</span> <span class="o">|</span><span class="n">host</span><span class="o">|</span> <span class="c1"># automatically discovers all peers</span>
  <span class="nb">puts</span> <span class="s2">"Host </span><span class="si">#{</span><span class="n">host</span><span class="o">.</span><span class="n">ip</span><span class="si">}</span><span class="s2">: id=</span><span class="si">#{</span><span class="n">host</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> datacenter=</span><span class="si">#{</span><span class="n">host</span><span class="o">.</span><span class="n">datacenter</span><span class="si">}</span><span class="s2"> rack=</span><span class="si">#{</span><span class="n">host</span><span class="o">.</span><span class="n">rack</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>

<span class="n">keyspace</span> <span class="o">=</span> <span class="s1">'system'</span>
<span class="n">session</span>  <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">keyspace</span><span class="p">)</span> <span class="c1"># create session, optionally scoped to a keyspace, to execute queries</span>

<span class="n">future</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute_async</span><span class="p">(</span><span class="s1">'SELECT keyspace_name, columnfamily_name FROM schema_columnfamilies'</span><span class="p">)</span> <span class="c1"># fully asynchronous api</span>
<span class="n">future</span><span class="o">.</span><span class="n">on_success</span> <span class="k">do</span> <span class="o">|</span><span class="n">rows</span><span class="o">|</span>
  <span class="n">rows</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
    <span class="nb">puts</span> <span class="s2">"The keyspace </span><span class="si">#{</span><span class="n">row</span><span class="o">[</span><span class="s1">'keyspace_name'</span><span class="o">]</span><span class="si">}</span><span class="s2"> has a table called </span><span class="si">#{</span><span class="n">row</span><span class="o">[</span><span class="s1">'columnfamily_name'</span><span class="o">]</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="n">future</span><span class="o">.</span><span class="n">join</span>
</code></pre>
<p>The host you specify is just a seed node, the driver will automatically discover all peers in the cluster.</p>

<p>Read more:</p>

<ul>
<li><a href="api/#connect-class_method"><code>Cql.connect</code> options</a></li>
<li><a href="api/session/#execute_async-instance_method"><code>Session#execute_async</code> options</a></li>
<li><a href="features">Usage documentation</a></li>
</ul>

<h2 id="upgrading-from-cql-rb">Upgrading from cql-rb</h2>

<p>Since Datastax Ruby driver introduces a lot of breaking api changes from cql-rb, it is important to understand what exactly has changed and why:</p>

<ul>
<li>
<a href="api/#connect-class_method">Cassandra.connect</a> returns a <a href="api/cluster/">Cassandra::Cluster</a> object that cannot be used to execute queries. A cluster is a metadata container and can be used to get information about all members of cassandra cluster that it is connected to, their respective datacenters, versions and more. <a href="api/host/">Read about Cassandra::Host</a> for more info. As well as to register listeners that will be notified whenever membership status changes.</li>
<li>
<a href="api/session/#execute-instance_method">Cassandra::Session#execute</a> or <a href="api/session/#execute_async-instance_method">Cassandra::Session#execute_async</a> should be used to execute queries and prepare statements.</li>
<li>
<a href="api/cluster/#connect-instance_method">Cluster#connect</a> or its asynchronous implementation - <a href="api/cluster/#connect_async-instance_method">Cluster#connect_async</a> - are used to get a <code>Cassandra::Session</code> instance, optionally scoped to a given <code>keyspace</code>.</li>
<li>
<a href="api/future/">Cassandra::Future</a> api is incompatible with <code>Ione::Future</code>. This is done both to sipmlify the api and to preserve backwards compatibility in the future. Futures interface will stay the same even if Ione implementation changes or if a different reactor altogether is used.</li>
<li>
<a href="api/result/">Cassandra::Result</a> has been enhanced to include <code>#execution_info</code> and <code>#next_page_async</code>. Methods <code>#trace_id</code> and <code>#metadata</code> have been removed. Trace can be accessed from <a href="api/execution/info/">Cassandra::Execution::Info</a> and metadata is considered private.</li>
<li>
<a href="api/statements/prepared/">Cassandra::Statements::Prepared</a> now includes <code>#execution_info</code>. However <code>#metadata</code> and <code>#result_metadata</code> have been remove and are not members of the public interface anymore.</li>
<li>Finally, <code>#execute</code> and <code>#batch</code> methods have been removed from all statement implementations. <a href="api/statements/">Statements</a> are expected to be passed to <code>Cassandra::Session#execute</code> for execution.</li>
</ul>

<p>Below is an example of how to create a thin backwards compatibility shim to ease migration from cql-rb to the ruby driver:</p>
<pre class="highlight"><code class="ruby"><span class="nb">require</span> <span class="s1">'cassandra'</span>
<span class="nb">require</span> <span class="s1">'ione'</span>

<span class="k">class</span> <span class="nc">PreparedStatement</span>
  <span class="kp">attr_reader</span> <span class="ss">:statement</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">statement</span><span class="p">)</span>
    <span class="vi">@client</span> <span class="o">=</span> <span class="n">client</span>
    <span class="vi">@statement</span> <span class="o">=</span> <span class="n">statement</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="vi">@client</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="vi">@statement</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">BatchStatement</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
    <span class="vi">@client</span> <span class="o">=</span> <span class="n">client</span>
    <span class="vi">@batch</span> <span class="o">=</span> <span class="n">batch</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="vi">@client</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="vi">@batch</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="vi">@batch</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="nb">self</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Client</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
    <span class="vi">@session</span> <span class="o">=</span> <span class="n">session</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="n">future</span> <span class="o">=</span> <span class="no">Ione</span><span class="o">::</span><span class="no">CompletableFuture</span><span class="o">.</span><span class="n">new</span>
    <span class="vi">@session</span><span class="o">.</span><span class="n">execute_async</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">on_complete</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span>
      <span class="k">if</span> <span class="n">e</span>
        <span class="n">future</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="n">future</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">future</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="n">future</span> <span class="o">=</span> <span class="no">Ione</span><span class="o">::</span><span class="no">CompletableFuture</span><span class="o">.</span><span class="n">new</span>
    <span class="vi">@session</span><span class="o">.</span><span class="n">prepare_async</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span><span class="o">.</span><span class="n">on_complete</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span>
      <span class="k">if</span> <span class="n">e</span>
        <span class="n">future</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="n">future</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="no">PreparedStatement</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">future</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">batch</span><span class="p">(</span><span class="n">type</span> <span class="o">=</span> <span class="ss">:logged</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="no">BatchStatement</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="vi">@session</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:"</span><span class="si">#{</span><span class="n">type</span><span class="si">}</span><span class="ss">_batch"</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">block_given?</span>
      <span class="k">yield</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
      <span class="n">batch</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">batch</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">close</span>
    <span class="n">future</span> <span class="o">=</span> <span class="no">Ione</span><span class="o">::</span><span class="no">CompletableFuture</span><span class="o">.</span><span class="n">new</span>
    <span class="vi">@session</span><span class="o">.</span><span class="n">close</span><span class="o">.</span><span class="n">on_complete</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span>
      <span class="k">if</span> <span class="n">e</span>
        <span class="n">future</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="n">future</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">future</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">cluster</span> <span class="o">=</span> <span class="no">Cassandra</span><span class="o">.</span><span class="n">connect</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">connect</span>
<span class="n">client</span>  <span class="o">=</span> <span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
</code></pre>
<h2 id="changelog-versioning">Changelog &amp; versioning</h2>

<p>Check out the <a href="https://github.com/datastax/ruby-driver/releases">releases on GitHub</a>. Version numbering follows the <a href="http://semver.org/">semantic versioning</a> scheme.</p>

<p>Private and experimental APIs, defined as whatever is not in the <a href="http://datastax.github.io/ruby-driver/api">public API documentation</a>, i.e. classes and methods marked as <code>@private</code>, will change without warning. If you’ve been recommended to try an experimental API by the maintainers, please let them know if you depend on that API. Experimental APIs will eventually become public, and knowing how they are used helps in determining their maturity.</p>

<p>Prereleases will be stable, in the sense that they will have finished and properly tested features only, but may introduce APIs that will change before the final release. Please use the prereleases and report bugs, but don’t deploy them to production without consulting the maintainers, or doing extensive testing yourself. If you do deploy to production please let the maintainers know as this helps determining the maturity of the release.</p>

<h2 id="known-bugs-limitations">Known bugs &amp; limitations</h2>

<ul>
<li>JRuby 1.6 is not officially supported, although 1.6.8 should work, if you’re stuck in JRuby 1.6.8 try and see if it works for you.</li>
<li>Because the driver reactor is using <code>IO.select</code>, the maximum number of tcp connections allowed is 1024.</li>
</ul>

<h2 id="copyright">Copyright</h2>

<p>Copyright 2013-2014 DataStax, Inc.</p>

<p>Licensed under the Apache License, Version 2.0 (the “License”); you may not use this file except in compliance with the License. You may obtain a copy of the License at</p>

<p><a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></p>

<p>Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an “AS IS” BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.</p>

        </div>
        <nav class="col-md-3 side-nav">
          <ol class="nav nav-pills nav-stacked toc" data-spy="affix" data-offset-top="60" data-offset-bottom="0">
<li><a href="#quick-start">Quick start</a></li>
<li><a href="#upgrading-from-cql-rb">Upgrading from cql-rb</a></li>
<li><a href="#changelog-versioning">Changelog &amp; versioning</a></li>
<li><a href="#known-bugs-limitations">Known bugs &amp; limitations</a></li>
<li><a href="#copyright">Copyright</a></li>
</ol>
        </nav>
      </div>
    </div>

    <script src="//code.jquery.com/jquery-2.1.0.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
  </body>
</html>
